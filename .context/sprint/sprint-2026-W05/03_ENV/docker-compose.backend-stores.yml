version: "3.9"

services:
  postgres:
    image: pgvector/pgvector:0.7.4-pg16
    container_name: agentcore-postgres
    profiles: ["core"]
    environment:
      POSTGRES_USER: agent_core
      POSTGRES_PASSWORD: agent_core
      POSTGRES_DB: agent_core
    ports:
      - "5432:5432"
    volumes:
      - ./.local-data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agent_core -d agent_core"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7.2-alpine
    container_name: agentcore-redis
    profiles: ["core", "cache-redis"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  valkey:
    image: valkey/valkey:7.2-alpine
    container_name: agentcore-valkey
    profiles: ["cache-valkey"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  keydb:
    image: eqalpha/keydb:alpine
    container_name: agentcore-keydb
    profiles: ["cache-keydb"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:RELEASE.2025-01-16T16-32-09Z
    container_name: agentcore-minio
    profiles: ["artifacts"]
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./.local-data/minio:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  chroma:
    image: ghcr.io/chroma-core/chroma:0.5.17
    container_name: agentcore-chroma
    profiles: ["vector-alt"]
    environment:
      IS_PERSISTENT: "true"
      ANONYMIZED_TELEMETRY: "false"
    ports:
      - "8000:8000"
    volumes:
      - ./.local-data/chroma:/chroma
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 5

  qdrant:
    image: qdrant/qdrant:v1.10.0
    container_name: agentcore-qdrant
    profiles: ["vector-alt"]
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - agentcore_qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  weaviate:
    image: semitechnologies/weaviate:1.24.10
    container_name: agentcore-weaviate
    profiles: ["vector-alt"]
    ports:
      - "8080:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: "25"
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
    volumes:
      - agentcore_weaviate:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongo:7.0
    container_name: agentcore-mongodb
    profiles: ["memory-alt"]
    ports:
      - "27017:27017"
    volumes:
      - agentcore_mongo:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 10s
      timeout: 5s
      retries: 5

  opensearch:
    image: opensearchproject/opensearch:2.12.0
    container_name: agentcore-opensearch
    profiles: ["search"]
    environment:
      discovery.type: single-node
      plugins.security.disabled: "true"
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - agentcore_opensearch:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9200/_cluster/health?pretty"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: bitnami/kafka:3.7.0
    container_name: agentcore-kafka
    profiles: ["event-alt"]
    environment:
      KAFKA_CFG_NODE_ID: "0"
      KAFKA_CFG_PROCESS_ROLES: "broker,controller"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "0@kafka:9093"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_LOG_DIRS: "/bitnami/kafka/data"
      ALLOW_PLAINTEXT_LISTENER: "yes"
    ports:
      - "9092:9092"
    volumes:
      - agentcore_kafka:/bitnami/kafka/data
    healthcheck:
      test: ["CMD", "bash", "-c", "kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1"]
      interval: 15s
      timeout: 5s
      retries: 5

  otel-collector:
    image: otel/opentelemetry-collector:0.95.0
    container_name: agentcore-otel
    profiles: ["observability"]
    ports:
      - "4317:4317"
      - "4318:4318"

volumes:
  agentcore_qdrant:
  agentcore_weaviate:
  agentcore_mongo:
  agentcore_opensearch:
  agentcore_kafka:
